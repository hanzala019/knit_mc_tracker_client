<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Analytics Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="styles/style.css" rel="stylesheet">
    <link href="styles/chart.css" rel="stylesheet">
    <style>
        /* Your existing styles remain unchanged */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .container-fluid {
            max-width: 1000px;
        }
        .navbar {
            justify-content: space-evenly !important;
        }
        .nav-link2 {
            font-size: 16px;
            color: #a9a4a4;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .nav-link2:hover {
            text-decoration: none;
            color: #007bff;
        }
        .nav-link2.active {
            color: #007bff;
            font-weight: bold;
        }
        .stat-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .stat-label {
            color: #515457;
            font-size: 0.9rem;
        }
        .machine-checkbox {
            margin: 0.5rem;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .download-button {
            margin-bottom: 0.5rem;
            margin-right: 0.5rem;
        }
        .machine-grid {
            display: flex;
            flex-wrap: wrap;
            margin: -0.25rem;
        }
        .machine-item {
            flex: 0 0 auto;
            width: 25%;
            padding: 0.25rem;
            box-sizing: border-box;
        }
        .machine-checkbox {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        .machine-checkbox .form-check-label {
            max-width: 100%;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.75rem;
        }
        @media (min-width: 1200px) {
            .machine-item { width: 20%; }
        }
        @media (min-width: 768px) {
            .machine-item { width: 25%; }
        }
        @media (min-width: 480px) {
            .machine-item { width: 50%; }
        }
    </style>
</head>
<body>
    <script src="nav.js"></script>
    <script src="helper functions/time.js"></script>
    <script src="helper functions/tables.js"></script>
    <script src="helper functions/charts.js"></script>

    <nav class="navbar">
        <div class="logo">LOGO</div>
        <div class="nav-links">
            <a href="./mc_log.html" class="nav-link">Machine Logs</a>
            <a href="./chart.html" class="nav-link">Machine Chart</a>
            <a href="./report.html" class="nav-link">Report</a>
            <a href="./simulate.html" class="nav-link">Simulation</a>
        </div>
        <div class="user-section">
            <button class="logout-button">Logout</button>
        </div>
    </nav>
    <div class="container-fluid py-4">
        <div class="row mb-2">
            <div class="col-12 text-end">
                <button class="btn btn-outline-secondary btn-sm" id="toggleFilters">Hide Filters</button>
            </div>
        </div>
        <div class="row mb-4" id="machineSelectionRow">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Machine and Date Selection</h5>
                    </div>
                    <div class="card-body" id="machineCheckboxes">
                        <div class="row mb-3">
                            <div class="col-md-3 col-sm-6">
                                <label for="dateFrom">From:</label>
                                <input type="date" id="dateFrom" class="form-control">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label for="dateTo">To:</label>
                                <input type="date" id="dateTo" class="form-control">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label for="shiftFilter">Shift:</label>
                                <select id="shiftFilter" class="form-control">
                                    <option value="">All Shifts</option>
                                    <option value="Day">Day (8 AM - 8 PM)</option>
                                    <option value="Night">Night (8 PM - 8 AM)</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6 d-flex align-items-end">
                                <button id="applyDates" class="btn btn-primary">Apply</button>
                            </div>
                        </div>
                        <div id="checkboxContainer" class="loading"></div>
                    </div>
                    <div class="card-footer">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllToggle">
                            <label class="form-check-label" for="selectAllToggle">Select All Machines</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link2 active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab">Overview</a>
            </li>
            <li class="nav-item">
                <a class="nav-link2" id="machine-analysis-tab" data-bs-toggle="tab" href="#machineAnalysis" role="tab">Machine Analysis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link2" id="reason-analysis-tab" data-bs-toggle="tab" href="#reasonAnalysis" role="tab">Reason Analysis</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="analyticsTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row" id="overviewStats">

                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-value" id="totalDowntime">-</div>
                            <div class="stat-label">Total Downtime</div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-value" id="uptimePercentage">-</div>
                            <div class="stat-label">Uptime Percentage</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-value" id="totalEvents">-</div>
                            <div class="stat-label">Total Stop Events</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-value" id="avgDowntime">-</div>
                            <div class="stat-label">Average Downtime per Event</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Machine Performance Overview</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <button class="btn btn-sm btn-outline-secondary download-button" onclick="downloadTable('overviewMachineTableBody', 'overview_machine_performance.csv', 'csv')">Download as CSV</button>
                                    <button class="btn btn-sm btn-outline-secondary download-button" onclick="downloadTable('overviewMachineTableBody', 'overview_machine_performance.pdf', 'pdf')">Download as PDF</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Machines</th>
                                                <th>Most Downtime Reason</th>
                                                <th>Events</th>
                                                <th>Avg Downtime</th>
                                                <th>Total Downtime</th>
                                                <th>Total Uptime</th>
                                                <th>NPT (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="overviewMachineTableBody"></tbody>
                                    </table>
                                </div>
                                <div class="row mt-4 mb-4">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h5 class="text-center">Downtime by Machine (seconds)</h5>
                                            <div id="machineBarChart"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h5 class="text-center">Stop Events by Machine</h5>
                                            <div id="reasonPieChart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Machine Analysis Tab -->
            <div class="tab-pane fade" id="machineAnalysis" role="tabpanel">
                <div class="row" id="machineAnalysisTables">
                    <div class="col-12 mb-2">
                        <button class="btn btn-sm btn-outline-primary download-button" onclick="downloadAllMachineTables('csv')">Download All as CSV</button>
                        <button class="btn btn-sm btn-outline-primary download-button" onclick="downloadAllMachineTables('pdf')">Download All as PDF</button>
                    </div>
                </div>
            </div>

            <!-- Reason Analysis Tab -->
            <div class="tab-pane fade" id="reasonAnalysis" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Downtime Reasons Analysis</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <button class="btn btn-sm btn-outline-secondary download-button" onclick="downloadTable('reasonComparisonTableBody', 'downtime_reason_analysis.csv', 'csv')">Download as CSV</button>
                                    <button class="btn btn-sm btn-outline-secondary download-button" onclick="downloadTable('reasonComparisonTableBody', 'downtime_reason_analysis.pdf', 'pdf')">Download as PDF</button>
                                </div>
                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Reason</th>
                                                <th>Downtime (min)</th>
                                                <th>Average Downtime (min)</th>
                                                <th>Events</th>
                                                <th>Occurrences/hr</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reasonComparisonTableBody"></tbody>
                                    </table>
                                </div>
                                <div id="reasonBarChart" class="chart-container" style="height: 300px; padding: 0px;"></div>
                                <div class="table-responsive mb-4 mt-4" style="font-size: 10px;">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr id="reasonMachineTableHeader"></tr>
                                        </thead>
                                        <tbody id="reasonMachineTableBody"></tbody>
                                    </table>
                                </div>
                                <div id="reasonScatterPlot" class="chart-container" style="height: 400px; padding: 0px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getCurrentTimeInMilliSeconds() {
            const now = Date.now();
            const startOfToday = new Date();
            startOfToday.setHours(0, 0, 0, 0);
            return Math.floor((now - startOfToday.getTime()) / 1000);
        }

        function getTimeRangeInSeconds(dateFrom, dateTo, numMachines) {
            const now = new Date();
            now.setHours(now.getHours()); // Adjust for GMT+6
            if (!dateFrom && !dateTo) {
                const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                return ((now - midnight) / 1000) * numMachines;
            }
            const startDate = dateFrom ? new Date(dateFrom) : new Date(now.getFullYear(), now.getMonth(), 1);
            const endDate = dateTo ? new Date(dateTo) : now;
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(endDate.getHours(), endDate.getMinutes(), endDate.getSeconds(), 999);
            const daysDiff = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            let totalSeconds;
            if (dateTo && new Date(dateTo).toDateString() === now.toDateString()) {
                const hoursToday = now.getHours() + (now.getMinutes() / 60);
                totalSeconds = ((daysDiff - 1) * 24 + hoursToday) * 60 * 60 * numMachines;
            } else {
                totalSeconds = daysDiff * 24 * 60 * 60 * numMachines;
            }
            return totalSeconds;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const tabContent = document.getElementById('analyticsTabContent');
            const tabPanes = Array.from(document.querySelectorAll('.tab-pane'));
            const tabIds = tabPanes.map(pane => pane.id);
            const overviewStats = document.getElementById('overviewStats');

            let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0, isHorizontallyScrollable = false;

            tabContent.addEventListener('touchstart', handleTouchStart, false);
            tabContent.addEventListener('touchmove', handleTouchMove, false);
            tabContent.addEventListener('touchend', handleTouchEnd, false);

            function isElementHorizontallyScrollable(element) {
                while (element && element !== tabContent) {
                    const hasOverflow = element.scrollWidth > element.clientWidth;
                    const isScrollable = window.getComputedStyle(element).overflowX === 'auto' || window.getComputedStyle(element).overflowX === 'scroll';
                    if (hasOverflow && isScrollable) return true;
                    element = element.parentElement;
                }
                return false;
            }

            function handleTouchStart(event) {
                touchStartX = event.touches[0].clientX;
                touchStartY = event.touches[0].clientY;
                const targetElement = document.elementFromPoint(touchStartX, touchStartY);
                isHorizontallyScrollable = targetElement ? isElementHorizontallyScrollable(targetElement) : false;
                tabPanes.forEach(pane => {
                    pane.style.transition = 'none';
                    pane.style.transform = pane.classList.contains('active') ? 'translateX(0)' : 'translateX(100%)';
                });
            }

            function handleTouchMove(event) {
                if (isHorizontallyScrollable) return;
                const moveX = event.touches[0].clientX - touchStartX;
                const moveY = event.touches[0].clientY - touchStartY;
                if (Math.abs(moveX) > Math.abs(moveY) && Math.abs(moveX) > 20) {
                    event.preventDefault(); // Fixed: Use event parameter
                    const activeTab = document.querySelector('.tab-pane.show.active');
                    const currentIndex = tabIds.indexOf(activeTab.id);
                    const direction = moveX > 0 ? -1 : 1;
                    const nextIndex = currentIndex + direction;
                    if (nextIndex >= 0 && nextIndex < tabIds.length) {
                        const currentPane = activeTab;
                        const nextPane = document.getElementById(tabIds[nextIndex]);
                        const swipePercentage = Math.min(Math.abs(moveX) / tabContent.clientWidth, 1);
                        const translateCurrent = moveX > 0 ? -swipePercentage * 100 : swipePercentage * 100;
                        const translateNext = moveX > 0 ? (1 - swipePercentage) * 100 : -(1 - swipePercentage) * 100;
                        currentPane.style.transform = `translateX(${translateCurrent}%)`;
                        nextPane.style.transform = `translateX(${translateNext}%)`;
                        nextPane.style.display = 'block';
                    }
                }
            }

            function handleTouchEnd(event) {
                touchEndX = event.changedTouches[0].clientX;
                touchEndY = event.changedTouches[0].clientY;
                if (isHorizontallyScrollable) {
                    resetTabPositions();
                    return;
                }
                const swipeDistanceX = touchEndX - touchStartX;
                const swipeDistanceY = touchEndY - touchStartY;
                const minSwipeDistance = 50;
                const maxVerticalMovement = 30;
                const activeTab = document.querySelector('.tab-pane.show.active');
                const currentIndex = tabIds.indexOf(activeTab.id);
                tabPanes.forEach(pane => pane.style.transition = 'transform 0.3s ease-in-out');
                if (Math.abs(swipeDistanceX) > minSwipeDistance && Math.abs(swipeDistanceY) < maxVerticalMovement) {
                    if (swipeDistanceX > 0 && currentIndex > 0) {
                        navigateToTab(tabIds[currentIndex - 1]);
                    } else if (swipeDistanceX < 0 && currentIndex < tabIds.length - 1) {
                        navigateToTab(tabIds[currentIndex + 1]);
                    } else {
                        resetTabPositions();
                    }
                } else {
                    resetTabPositions();
                }
            }

            function navigateToTab(tabId) {
                const tabLink = document.querySelector(`[data-bs-target="#${tabId}"]`) || document.querySelector(`[href="#${tabId}"]`);
                if (tabLink) {
                    const nextPane = document.getElementById(tabId);
                    const activePane = document.querySelector('.tab-pane.show.active');
                    if (activePane.id !== tabId) {
                        const direction = tabIds.indexOf(tabId) > tabIds.indexOf(activePane.id) ? -1 : 1;
                        activePane.style.transform = `translateX(${direction * 100}%)`;
                        nextPane.style.transform = 'translateX(0)';
                        nextPane.style.display = 'block';
                        setTimeout(() => {
                            if (typeof bootstrap !== 'undefined') {
                                const tab = new bootstrap.Tab(tabLink);
                                tab.show();
                            } else {
                                tabPanes.forEach(pane => pane.classList.remove('show', 'active'));
                                document.querySelectorAll('[data-bs-toggle="tab"], [data-toggle="tab"]').forEach(link => {
                                    link.classList.remove('active');
                                    link.setAttribute('aria-selected', 'false');
                                });
                                nextPane.classList.add('show', 'active');
                                tabLink.classList.add('active');
                                tabLink.setAttribute('aria-selected', 'true');
                            }
                            resetTabPositions(false);
                            // Hide or show overview stats based on active tab
                            overviewStats.style.display = tabId === 'overview' ? 'flex' : 'none';
                        }, 300);
                    }
                }
            }

            function resetTabPositions(animate = true) {
                tabPanes.forEach(pane => {
                    pane.style.transition = animate ? 'transform 0.3s ease-in-out' : 'none';
                    pane.style.transform = pane.classList.contains('active') ? 'translateX(0)' : 'translateX(100%)';
                    if (!pane.classList.contains('active')) {
                        setTimeout(() => pane.style.display = 'none', animate ? 300 : 0);
                    }
                });
            }

            // Bootstrap tab event listener to handle stat visibility
            document.querySelectorAll('#analyticsTabs a').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function() {
                    const targetId = this.getAttribute('href').substring(1);
                    overviewStats.style.display = targetId === 'overview' ? 'flex' : 'none';
                });
            });
        });

        const style = document.createElement('style');
        style.textContent = `
            .tab-pane { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: none; will-change: transform; }
            .tab-pane.show.active { display: block; position: relative; }
            #analyticsTabContent { position: relative; overflow: hidden; }
            .swipe-left { box-shadow: -5px 0 5px rgba(0, 0, 0, 0.2); }
            .swipe-right { box-shadow: 5px 0 5px rgba(0, 0, 0, 0.2); }
        `;
        document.head.appendChild(style);

        document.addEventListener("DOMContentLoaded", () => {
            const links = document.querySelectorAll(".nav-link");
            const currentPage = window.location.pathname.split("/").pop().split(".")[0];
            links.forEach(link => {
                if (link.getAttribute("href").split("/").pop().split(".")[0] === currentPage) {
                    link.classList.add("active");
                }
            });
        });

        let data = { machines: [], result: [] };
        let machineViews = {};
        const api = "https://organic-relative-wren.ngrok-free.app" || "https://knit-mc-tracker-server.onrender.com";
        let filtersVisible = true;
        const machineColors = {};
        const defaultColors = ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'];
        let analysis = {};

        const handleError = (error, message = 'An error occurred') => console.error(error);

        function setMachineView(machine, view) {
            machineViews[machine] = view;
            const btnGroupElement = d3.select(`#machine-${machine}-scatter`).node().parentNode.querySelector('.view-controls .btn-group');
            const btnGroup = d3.select(btnGroupElement);
            btnGroup.selectAll('.btn').classed('active', function() { return this.textContent === view; });
            const machineEvents = window.cachedMachineData.find(m => m.machine === machine).result;
            d3.select(`#machine-${machine}-scatter`).html("");
            d3.select(`#machine-${machine}-histogram`).html("");
            renderMachineScatterPlot(machine, machineEvents, view);
            renderMachineStackedHistogram(machine, machineEvents, view);
        }

        async function fetchData() {
            try {
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const url = `${api}/api/mc-report`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_date: dateFrom || new Date().toISOString().split('T')[0],
                        to_date: dateTo || new Date().toISOString().split('T')[0]
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                let reasonwise_npt = [
                    { reason: "Maintenance", value: 0, count: 0 },
                    { reason: "Needle Breakage", value: 0, count: 0 },
                    { reason: "No Order / No Program", value: 0, count: 0 },
                    { reason: "No Yarn", value: 0, count: 0 },
                    { reason: "Power", value: 0, count: 0 },
                    { reason: "Program Change", value: 0, count: 0 },
                    { reason: "Roll Cutting", value: 0, count: 0 },
                    { reason: "Yarn Breakage", value: 0, count: 0 },
                    { reason: "N/A", value: 0, count: 0 },
                    { reason: "No operation data", value: 0, count: 0 }
                ];
                data.result.forEach(element => {
                    for (let i = 0; i < reasonwise_npt.length; i++) {
                        if (element[6] === reasonwise_npt[i].reason) {
                            reasonwise_npt[i].value += element[4];
                            reasonwise_npt[i].count++;
                            break;
                        } else if (element[6] === null) {
                            reasonwise_npt[8].value += element[4];
                            reasonwise_npt[8].count++;
                            break;
                        }
                    }
                });
                const machineData = [];
                let mc_no = JSON.parse(localStorage.getItem("user"));
                data.machines = mc_no.machine === "All" ? data.machines : [mc_no.machine];
                data.machines.forEach(element => {
                    machineData.push({
                        machine: element,
                        result: data.result.filter(item => item[1] === element)
                    });
                });
                return machineData;
            } catch (error) {
                handleError(error, 'Failed to fetch data');
                return null;
            }
        }

        async function initializePage() {
            try {
                const machineData = await fetchData();
                if (machineData && Array.isArray(machineData)) {
                    console.log("Processed machine data:", machineData);
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('dateFrom').value = today;
                    document.getElementById('dateTo').value = today;
                    initializeMachineReasonCheckboxes(machineData);
                    initializeEventListeners(machineData);
                    window.cachedMachineData = machineData;
                    analyzeData(machineData);
                } else {
                    document.getElementById('checkboxContainer').innerHTML = '<div class="alert alert-danger">Failed to load machine data. Please check the API endpoint.</div>';
                }
            } catch (error) {
                handleError(error, 'Failed to initialize dashboard');
                document.getElementById('checkboxContainer').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function initializeEventListeners() {
            const selectAllToggle = document.getElementById('selectAllToggle');
            if (selectAllToggle) selectAllToggle.addEventListener('change', () => updateSelection('machine', selectAllToggle.checked));
            const toggleFiltersButton = document.getElementById('toggleFilters');
            if (toggleFiltersButton) toggleFiltersButton.addEventListener('click', toggleFilters);
            const tabElements = document.querySelectorAll('#analyticsTabs a');
            tabElements.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabInstance = new bootstrap.Tab(e.target);
                    tabInstance.show();
                    analyzeData();
                });
            });
            const applyDates = document.getElementById('applyDates');
            if (applyDates) applyDates.addEventListener('click', () => analyzeData());
        }

        function updateSelection(type, checked) {
            const checkboxes = document.querySelectorAll(`.${type}-checkbox input[type="checkbox"]`);
            checkboxes.forEach(checkbox => checkbox.checked = checked);
            analyzeData();
        }

        function toggleFilters() {
            const machineSelectionRow = document.getElementById('machineSelectionRow');
            const toggleFiltersButton = document.getElementById('toggleFilters');
            filtersVisible = !filtersVisible;
            machineSelectionRow.style.display = filtersVisible ? 'flex' : 'none';
            toggleFiltersButton.textContent = filtersVisible ? 'Hide Filters' : 'Show Filters';
        }

        function initializeMachineReasonCheckboxes(machineData) {
            const container = document.getElementById('checkboxContainer');
            container.innerHTML = '';
            if (!Array.isArray(machineData) || machineData.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No machine data available</div>';
                return;
            }
            const machineDiv = document.createElement('div');
            machineDiv.className = 'mb-3';
            machineDiv.innerHTML = '<h5>Machines:</h5>';
            const machineRow = document.createElement('div');
            machineRow.className = 'row g-1 machine-grid';
            machineData.forEach((machineItem, index) => {
                const machine = machineItem.machine;
                const col = document.createElement('div');
                col.className = 'col-xxl-2 col-xl-2 col-lg-2 col-md-3 col-sm-4 col-6';
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'form-check machine-checkbox small';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'form-check-input';
                input.id = `machine-${machine}`;
                input.value = machine;
                input.checked = true;
                input.addEventListener('change', () => analyzeData());
                const label = document.createElement('label');
                label.className = 'form-check-label text-truncate';
                label.htmlFor = `machine-${machine}`;
                label.textContent = machine;
                label.title = machine;
                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                col.appendChild(checkboxDiv);
                machineRow.appendChild(col);
                machineColors[machine] = defaultColors[index % defaultColors.length];
            });
            machineDiv.appendChild(machineRow);
            container.appendChild(machineDiv);
        }

        async function analyzeData(machineData) {
    try {
        if (!machineData) {
            machineData = window.cachedMachineData;
            if (!machineData) {
                console.error("No machine data available for analysis");
                return;
            }
        } else {
            window.cachedMachineData = machineData; // Initial caching
        }

        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const shiftFilter = document.getElementById('shiftFilter').value;
        const selectedMachines = getSelectedCheckboxes('machine');

        let filteredMachineData = [];
        const totalTimeSeconds = getTimeRangeInSeconds(dateFrom, dateTo, selectedMachines.length);

        const now = new Date();
        now.setHours(now.getHours() + 6);

        if (dateFrom || dateTo) {
            const startDate = dateFrom ? new Date(dateFrom) : new Date(now.getFullYear(), now.getMonth(), 1);
            const endDate = dateTo ? new Date(dateTo) : now;
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);

            if (dateFrom && !dateTo) {
                dateTo = now.toISOString().slice(0, 10);
                document.getElementById('dateTo').value = dateTo;
            } else if (!dateFrom && dateTo) {
                dateFrom = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
                document.getElementById('dateFrom').value = dateFrom;
            }

            const payload = {
                from_date: dateFrom || null,
                to_date: dateTo || null,
                mc_no: selectedMachines.length > 0 ? selectedMachines : null
            };

            const response = await fetch(`${api}/api/mc-report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            if (!data.success || !data.result) throw new Error('Invalid response from server');

            filteredMachineData = data.result.map(event => ({
                machine: event[1],
                result: [{ 2: event[2], 3: event[3], 4: event[4], 6: event[6] }]
            })).reduce((acc, curr) => {
                const existing = acc.find(m => m.machine === curr.machine);
                if (existing) existing.result.push(...curr.result);
                else acc.push(curr);
                return acc;
            }, []);
        } else {
            const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            filteredMachineData = [...machineData];
        }

        if (filteredMachineData.length > 0 && shiftFilter) {
            filteredMachineData = filteredMachineData.map(machineItem => ({
                machine: machineItem.machine,
                result: machineItem.result.filter(event => {
                    let matchesShift = true;
                    if (shiftFilter) {
                        const offTime = new Date(event[2]);
                        offTime.setHours(offTime.getHours() + 6);
                        const hour = offTime.getHours();
                        matchesShift = shiftFilter === 'Day' ? (hour >= 8 && hour < 20) : (hour >= 20 || hour < 8);
                    }
                    return matchesShift;
                })
            }));
        }

        // Update window.cachedMachineData with filtered data
        window.cachedMachineData = filteredMachineData.length > 0 && !filteredMachineData.every(m => m.result.length === 0)
            ? filteredMachineData
            : [];

        if (window.cachedMachineData.length === 0) {
            console.warn('No data after filtering');
            analysis = { machines: {}, reasons: {}, totalDowntime: 0, totalEvents: 0, uptime: 0, npt: 0, totalTime: totalTimeSeconds };
        } else {
            analysis = analyzeEvents(selectedMachines, window.cachedMachineData, totalTimeSeconds);
        }

        console.log('Updated window.cachedMachineData:', window.cachedMachineData);
        updateOverviewTab(analysis);
        updateMachineAnalysisTab(analysis); // No need to pass filteredMachineData
        updateReasonAnalysisTab(analysis); // No need to pass filteredMachineData
        renderOverviewCharts(analysis);
    } catch (error) {
        handleError(error, 'Failed to analyze data');
        analysis = { machines: {}, reasons: {}, totalDowntime: 0, totalEvents: 0, uptime: 0, npt: 0, totalTime: 0 };
        window.cachedMachineData = []; // Reset to empty array on error
        console.log('Catch block updated window.cachedMachineData:', window.cachedMachineData);
        updateOverviewTab(analysis);
        updateMachineAnalysisTab(analysis);
        updateReasonAnalysisTab(analysis);
        renderOverviewCharts(analysis);
    }
}

        function getSelectedCheckboxes(type) {
            const checkboxes = document.querySelectorAll(`.${type}-checkbox input:checked`);
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        function analyzeEvents(selectedMachines, machineData, totalTimeSeconds = null) {
            const now = new Date();
            now.setHours(now.getHours());
            const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const defaultTimePassed = (now - midnight) / 1000;
            console.log(defaultTimePassed, totalTimeSeconds)
            const analysis = {
                machines: {},
                reasons: {},
                totalDowntime: 0,
                totalEvents: 0,
                totalTime: totalTimeSeconds || (defaultTimePassed * selectedMachines.length || 1),
                uptime: 0,
                npt: 0,
                hourlyDowntime: {},
                firstEventTime: Infinity,
                lastEventTime: 0
            };
            selectedMachines.forEach(machine => {
                analysis.machines[machine] = {
                    downtime: 0,
                    uptime: 0,
                    npt: 0,
                    events: 0,
                    reasonEventsCount: {},
                    reasonTotalDowntime: {}
                };
                analysis.hourlyDowntime[machine] = Array(24).fill(0);
            });
            let reasonwise_npt = [
                { reason: "Maintenance", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "Needle Breakage", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "No Order / No Program", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "No Yarn", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "Power", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "Program Change", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "Roll Cutting", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "Yarn Breakage", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "N/A", value: 0, count: 0, hourlyEvents: Array(24).fill(0) },
                { reason: "No operation data", value: 0, count: 0, hourlyEvents: Array(24).fill(0) }
            ];
            if (!machineData || !Array.isArray(machineData)) {
                console.warn("No valid machine data to analyze");
                return analysis;
            }
            machineData.forEach(machineItem => {
                if (!selectedMachines.includes(machineItem.machine)) return;
                const machine = machineItem.machine;
                const machineResults = machineItem.result;
                if (!Array.isArray(machineResults) || machineResults.length === 0) return;
                machineResults.forEach(event => {
                    if (event[2]) {
                        const startTime = new Date(event[2]).getTime();
                        if (startTime < analysis.firstEventTime) analysis.firstEventTime = startTime;
                    }
                    if (event[3]) {
                        const endTime = new Date(event[3]).getTime();
                        if (endTime > analysis.lastEventTime) analysis.lastEventTime = endTime;
                    }
                });
                machineResults.forEach(event => {
                    analysis.totalEvents++;
                    analysis.machines[machine].events++;
                    if (event[4]) {
                        const downtimeSeconds = event[4];
                        analysis.totalDowntime += downtimeSeconds;
                        analysis.machines[machine].downtime += downtimeSeconds;
                        analysis.machines[machine].npt += downtimeSeconds;
                        const offDate = new Date(event[2]);
                        const hourOfDay = offDate.getHours();
                        analysis.hourlyDowntime[machine][hourOfDay] += downtimeSeconds;
                        const reason = event[6] || "N/A";
                        let reasonData = reasonwise_npt.find(r => r.reason === reason);
                        if (reasonData) {
                            reasonData.count++;
                            reasonData.value += downtimeSeconds;
                            reasonData.hourlyEvents[hourOfDay]++;
                        }
                        analysis.machines[machine].reasonEventsCount[reason] = (analysis.machines[machine].reasonEventsCount[reason] || 0) + 1;
                        analysis.machines[machine].reasonTotalDowntime[reason] = (analysis.machines[machine].reasonTotalDowntime[reason] || 0) + downtimeSeconds;
                    }
                });
            });
            analysis.uptime = analysis.totalTime - analysis.totalDowntime;
            analysis.npt = analysis.totalDowntime;
            selectedMachines.forEach(machine => {
                const machineTotalTime = analysis.totalTime / selectedMachines.length;
                analysis.machines[machine].uptime = machineTotalTime - analysis.machines[machine].downtime;
                analysis.machines[machine].npt = analysis.machines[machine].downtime;
            });
            analysis.avgDowntime = analysis.totalEvents > 0 ? (analysis.totalDowntime / analysis.totalEvents).toFixed(2) : 0;
            analysis.reasonwise_npt = reasonwise_npt;
            return analysis;
        }

        function updateOverviewTab(analysis) {
           
            const totalDowntimeElement = document.getElementById('totalDowntime');
            
            const uptimePercentageElement = document.getElementById('uptimePercentage');
            const totalEventsElement = document.getElementById('totalEvents');
            const avgDowntimeElement = document.getElementById('avgDowntime');

            
            if (totalDowntimeElement) totalDowntimeElement.textContent = formatToHoursOnly(analysis.totalDowntime);
            
            if (uptimePercentageElement) uptimePercentageElement.textContent = 
                (analysis.totalTime > 0 ? ((analysis.uptime / analysis.totalTime) * 100).toFixed(2) : 0) + "%";
            if (totalEventsElement) totalEventsElement.textContent = analysis.totalEvents;
            if (avgDowntimeElement) avgDowntimeElement.textContent = formatSeconds(analysis.avgDowntime);

            updateOverviewTable(analysis);
        }

        function updateMachineAnalysisTab(analysis) {
            updateMachineAnalysisTables(analysis);
        }

        function updateMachineAnalysisTables(analysis) {
            const machineAnalysisTablesContainer = document.getElementById('machineAnalysisTables');
            machineAnalysisTablesContainer.innerHTML = '';
            const machineLabels = Object.keys(analysis.machines);
            let allReasons = ["Maintenance", "Needle Breakage", "No Order / No Program", "No Yarn", "Power", "Program Change", "Roll Cutting", "Yarn Breakage", "N/A"];
            const downloadAllButtonDiv = document.createElement('div');
            downloadAllButtonDiv.className = 'col-12 mb-2';
            downloadAllButtonDiv.innerHTML = `
                <div class="download-all-buttons">
                    <button class="btn btn-sm btn-outline-primary download-button" onclick="downloadAllMachineTables('csv')">Download All as CSV</button>
                    <button class="btn btn-sm btn-outline-primary download-button" onclick="downloadAllMachineTables('pdf')">Download All as PDF</button>
                </div>
            `;
            machineAnalysisTablesContainer.appendChild(downloadAllButtonDiv);
            machineLabels.forEach(machine => {
                const machineData = analysis.machines[machine];
                const machineEvents = window.cachedMachineData.find(m => m.machine === machine)?.result || [];
                const card = document.createElement('div');
                card.className = 'col-md-12 mb-4';
                card.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">${machine} Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="mb-2">
                                        <button class="btn btn-sm btn-outline-secondary download-button" onclick="downloadTable('machine-${machine}-reason-body', 'machine_${machine}_analysis.csv', 'csv')">Download as CSV</button>
                                        <button class="btn btn-sm btn-outline-secondary download-button" onclick="downloadTable('machine-${machine}-reason-body', 'machine_${machine}_analysis.pdf', 'pdf')">Download as PDF</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Reason</th>
                                                    <th>Events</th>
                                                    <th>Avg Downtime</th>
                                                    <th>Total Downtime</th>
                                                    <th>NPT (%)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="machine-${machine}-reason-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="view-controls mb-2">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary active" data-view="AM" data-machine="${machine}">AM</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-view="PM" data-machine="${machine}">PM</button>
                                        </div>
                                    </div>
                                    <div id="machine-${machine}-scatter" class="scatter-plot" style="height: 250px;"></div>
                                    <div id="machine-${machine}-histogram" class="histogram-plot" style="height: 250px; margin-top: 20px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                machineAnalysisTablesContainer.appendChild(card);
                const tableBody = d3.select(`#machine-${machine}-reason-body`);
                let totalEvents = 0, totalDowntime = 0;
                const tableRows = tableBody.selectAll('tr.reason-row')
                    .data(allReasons)
                    .enter()
                    .append('tr')
                    .attr('class', 'reason-row');
                tableRows.each(function(reason) {
                    const reasonDowntime = machineData.reasonTotalDowntime[reason] || 0;
                    const reasonEvents = machineData.reasonEventsCount[reason] || 0;
                    const avgReasonDowntime = reasonEvents > 0 ? (reasonDowntime / reasonEvents) : 0;
                    const nptReasonPercentage = analysis.totalTime > 0 ? ((reasonDowntime / analysis.totalTime) * 100).toFixed(2) : '0.00';
                    totalEvents += reasonEvents;
                    totalDowntime += reasonDowntime;
                    d3.select(this).append('td').text(reason);
                    d3.select(this).append('td').text(reasonEvents);
                    d3.select(this).append('td').text(formatSeconds(avgReasonDowntime));
                    d3.select(this).append('td').text(formatSeconds(reasonDowntime));
                    d3.select(this).append('td').text(nptReasonPercentage + "%");
                });
                const totalAvgDowntime = totalEvents > 0 ? (totalDowntime / totalEvents) : 0;
                const totalNptPercentage = analysis.totalTime > 0 ? ((totalDowntime / analysis.totalTime) * 100).toFixed(2) : '0.00';
                const totalRow = tableBody.append('tr')
                    .attr('class', 'total-row font-weight-bold')
                    .style('background-color', '#f8f9fa');
                totalRow.append('td').text('Total').style('font-weight', 'bold');
                totalRow.append('td').text(totalEvents).style('font-weight', 'bold');
                totalRow.append('td').text(formatSeconds(totalAvgDowntime)).style('font-weight', 'bold');
                totalRow.append('td').text(formatSeconds(totalDowntime)).style('font-weight', 'bold');
                totalRow.append('td').text(totalNptPercentage + "%").style('font-weight', 'bold');
                const buttons = card.querySelectorAll('.view-controls .btn-group .btn');
                buttons.forEach(button => {
                    button.addEventListener('click', function() {
                        const view = this.getAttribute('data-view');
                        const machine = this.getAttribute('data-machine');
                        setMachineView(machine, view);
                    });
                });
                machineViews[machine] = 'AM';
                renderMachineScatterPlot(machine, machineEvents, 'AM');
                renderMachineStackedHistogram(machine, machineEvents, 'AM');
            });
        }

        function updateReasonAnalysisTab(analysis) {
            updateReasonComparisonTable(analysis);
            renderReasonBarChart(analysis);
            renderReasonMachineTable(analysis);
            renderReasonScatterPlot(analysis);
        }

        initializePage();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
</body>
</html>